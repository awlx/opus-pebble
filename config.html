<!DOCTYPE HTML>
<html>

<head>
    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.blue-red.min.css" />
    <script src="https://storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style type="text/css">
        .demo-card-wide {
            margin: 20px auto 40px;
        }

        #feedback {
            text-align: right;
            float: right;
        }


    </style>
    <!-- start Mixpanel -->
    <script type="text/javascript">
        (function (e, b) {
            if (!b.__SV) {
                var a, f, i, g;
                window.mixpanel = b;
                b._i = [];
                b.init = function (a, e, d) {
                    function f(b, h) {
                        var a = h.split(".");
                        2 == a.length && (b = b[a[0]], h = a[1]);
                        b[h] = function () {
                            b.push([h].concat(Array.prototype.slice.call(arguments, 0)))
                        }
                    }
                    var c = b;
                    "undefined" !== typeof d ? c = b[d] = [] : d = "mixpanel";
                    c.people = c.people || [];
                    c.toString = function (b) {
                        var a = "mixpanel";
                        "mixpanel" !== d && (a += "." + d);
                        b || (a += " (stub)");
                        return a
                    };
                    c.people.toString = function () {
                        return c.toString(1) + ".people (stub)"
                    };
                    i = "disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
                    for (g = 0; g < i.length; g++) f(c, i[g]);
                    b._i.push([a, e, d])
                };
                b.__SV = 1.2;
                a = e.createElement("script");
                a.type = "text/javascript";
                a.async = !0;
                a.src = "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL ? MIXPANEL_CUSTOM_LIB_URL : "file:" === e.location.protocol && "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//) ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js" : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";
                f = e.getElementsByTagName("script")[0];
                f.parentNode.insertBefore(a, f)
            }
        })(document, window.mixpanel || []);
        mixpanel.init('6229cfb42de97ef516b9da89c4f96ac1');
    </script>
    <!-- end Mixpanel -->
</head>

<body>
    <div class="demo-card-wide mdl-card mdl-shadow--2dp">
        <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Opus Settings for Kodi</h2>
        </div>
        <form id="form">
            <div class="mdl-card__supporting-text">
                Configure Opus here.
                <br /> Then confirm your changes with the "Save" button.
            </div>
            <div class="mdl-card__supporting-text">
                <fieldset class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                    <input class="mdl-textfield__input" type="text" id="ip" name="ip" required="required" autocapitalize="off" autocorrect="off" >
                    <label class="mdl-textfield__label" for="ip">Kodi IP Address</label>
                    <span class="mdl-textfield__error">Enter Kodi's local IP address</span>
                </fieldset>
            </div>
            <div class="mdl-card__supporting-text">
                <fieldset >
                    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-update-ui">
                        <input type="checkbox" id="switch-update-ui" class="mdl-switch__input" checked>
                        <span class="mdl-switch__label">Regularly update display</span>
                    </label>
                    <span>
                        Query Kodi a few times per minute for its current state.<br />
                        You can always shake the watch to refresh.
                    </span>
                </fieldset>
            </div>
            <div class="mdl-card__supporting-text">
                <fieldset>
                    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-vibe-long-press">
                        <input type="checkbox" id="switch-vibe-long-press" class="mdl-switch__input" checked>
                        <span class="mdl-switch__label">Vibrate on long press</span>
                    </label>
                </fieldset>
            </div>
            <div class="mdl-card__supporting-text">
                <fieldset>
                    <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect" for="switch-show-clock">
                        <input type="checkbox" id="switch-show-clock" class="mdl-switch__input" checked>
                        <span class="mdl-switch__label">Show clock line with current time</span>
                    </label>
                </fieldset>
            </div>
           <div class="mdl-card__supporting-text">
                <fieldset>
                    <span>What to start when nothing is playing:</span>
                    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-partymode">
                        <input type="radio" id="option-partymode" class="mdl-radio__button" name="playActionWhenStopped" value="partymode" checked>
                        <span class="mdl-radio__label">ðŸŽ‰Party mode</span>
                    </label>
                    <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="option-play-last">
                        <input type="radio" id="option-play-last" class="mdl-radio__button" name="playActionWhenStopped" value="playLast">
                        <span class="mdl-radio__label">Last playing item</span>
                    </label>
                </fieldset>
            </div>
            <div class="mdl-card__actions mdl-card--border">
                <button type="submit" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                    Save
                </button>
                <p id="feedback"></p>
            </div>
        </form>
    </div>
    <span id="log"></span>


    <script type="text/javascript">
        (function () {
            var config;

            // Get query variables
            function getQueryParam(variable, defaultValue) {
              // Find all URL parameters
              var query = location.search.substring(1);
              var vars = query.split('&');
              for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');

                // If the query variable parameter is found, decode it to use and return it for use
                if (pair[0] === variable) {
                  return decodeURIComponent(pair[1]);
                }
              }
              return defaultValue || false;
            }

            document.getElementById('form').addEventListener('submit', function(event) {
                event.preventDefault();
                event.stopPropagation();

                var settings = {
                    ip: document.getElementById('ip').value.trim(),
                    vibeOnLongPress: document.getElementById('switch-vibe-long-press').checked,
                    updateUi: document.getElementById('switch-update-ui').checked,
                    showClock: document.getElementById('switch-show-clock').checked,
                    playActionWhenStopped: document.getElementById('option-play-last').checked ? 'playLast' : 'partymode'
                };

                log('Saved.<br />' + JSON.stringify(settings) + '<br/>' + encodeURIComponent(JSON.stringify(settings)));

                var trackableSettings = JSON.parse(JSON.stringify(settings));
                trackableSettings.kodiIp = settings.id;
                delete trackableSettings.ip;
                mixpanel.track("Config saved", trackableSettings);

                setTimeout(function() {
                    // Set the return URL depending on the runtime environment
                    document.location = getQueryParam('return_to', 'pebblejs://close#') + encodeURIComponent(JSON.stringify(settings));
                }, 300);
            });

            document.getElementById('ip').addEventListener('change', function(event) {
                if (location.search.indexOf('testing') > -1) {
                    sendKodiRequest();
                }
            });

            function log(text) {
                setTimeout(function() {
                    document.getElementById('log').innerHTML = text;
                }, 1000);
            }

            function sendKodiRequest() {
                var request = new XMLHttpRequest();
                var data = {
                    'jsonrpc': '2.0',
                    'method': 'JSONRPC.Ping',
                    'id': Math.ceil(Math.random() * 10000)
                };

                request.addEventListener('load', function(data) {
                    log('success' + JSON.stringify(data));
                });
                request.addEventListener('error', function(error) {
                    log('error' + JSON.stringify(error));
                });
                request.open('GET', 'http://'+ document.getElementById('ip').value + '/jsonrpc?jsonCallback=bummm&request=' + encodeURIComponent(JSON.stringify(data)));
                request.setRequestHeader('Content-type', 'application/javascript');
                request.send();
            }




            (function init() {
                try {
                    config = JSON.parse(decodeURIComponent(window.location.hash.substr(1)));
                    mixpanel.identify(config.uid);
                    if (config.ip) {
                        document.getElementById('ip').value = config.ip;
                    }
                    document.getElementById('switch-vibe-long-press').checked = config.vibeOnLongPress;
                    document.getElementById('switch-update-ui').checked = config.updateUi;
                    document.getElementById('switch-show-clock').checked = config.showClock;
                    if (config.playActionWhenStopped === 'playLast') {
                        document.getElementById('option-play-last').checked = true;
                    } else {
                        document.getElementById('option-partymode').checked = true;
                    }
                } catch (e) {
                    document.getElementById('switch-vibe-long-press').checked = true;
                    document.getElementById('switch-update-ui').checked = true;
                    document.getElementById('switch-show-clock').checked = false;
                    document.getElementById('option-partymode').checked = true;

                    mixpanel.track('Config, Parsing error', {
                        detectedHash: decodeURIComponent(window.location.hash.substr(1))
                    });

                    log('Could not parse current configuration.');
                }
                mixpanel.track('Config viewed');
            })();
        })();
    </script>
</body>

</html>
